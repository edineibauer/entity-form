var entity={},dicionarios={},identifier={},defaults={},data={image:["png","jpg","jpeg","gif","bmp","tif","tiff","psd","svg"],video:["mp4","avi","mkv","mpeg","flv","wmv","mov","rmvb","vob","3gp","mpg"],audio:["mp3","aac","ogg","wma","mid","alac","flac","wav","pcm","aiff","ac3"],document:["txt","doc","docx","dot","dotx","dotm","ppt","pptx","pps","potm","potx","pdf","xls","xlsx","xltx","rtf"],compact:["rar","zip","tar","7z"],denveloper:["html","css","scss","js","tpl","json","xml","md","sql","dll"]};readDefaults(),readDicionarios(),entityReset();function readDefaults(){post("entity-form","load/defaults",function(a){defaults=a})}function readIdentifier(){post("entity-form","load/identifier",function(a){identifier=a})}function readDicionarios(){readIdentifier(),post("entity-form","load/dicionarios",function(a){dicionarios=a,$("#entity-space, #relation").html(""),$.each(dicionarios,function(b){copy("#tpl-entity","#entity-space",b,!0),$("#relation").append("<option value='"+b+"'>"+b+"</option>")})})}function entityReset(){entity={name:"",edit:null}}function entityEdit(a){("undefined"==typeof a&&""!==entity.name||"undefined"!=typeof a&&a!==entity.name)&&(saveEntity(!0),entityReset(),"undefined"!=typeof a&&(entity.name=a),showEntity())}function showEntity(){$("#entityName").val(entity.name).focus(),$("#entityAttr").html(""),$.each(dicionarios[entity.name],function(a,b){copy("#tpl-attrEntity","#entityAttr",[a,b.column],!0)})}function saveEntity(a){checkSaveAttr()&&2<entity.name.length&&"undefined"!=typeof dicionarios[entity.name]&&!$.isEmptyObject(dicionarios[entity.name])&&post("entity-form","save/entity",{name:entity.name,dados:dicionarios[entity.name],id:identifier[entity.name]},function(b){b&&"undefined"==typeof a&&($("body").panel(themeNotify("Salvo")),readDicionarios())})}function resetAttr(a){entity.edit="undefined"==typeof a?null:a,$(".selectInput").css("color","#CCCCCC").val(""),$("#format-source").addClass("hide"),$("#allowBtnAdd, #spaceValueAllow").removeClass("hide"),$("#spaceValueAllow").html(""),$(".file-format").each(function(){$(this).prop("checked",!1),$("."+$(this).attr("id")+"-format").prop("checked",!1)}),null===entity.edit?$(".selectInput, #relation").removeAttr("disabled").removeClass("disabled"):$(".selectInput, #relation").attr("disabled","disabled").addClass("disabled"),applyAttr(getDefaultsInfo())}function editAttr(a){a!==entity.edit&&checkSaveAttr()&&resetAttr(a)}function checkSaveAttr(){var a=!0;if(checkRequiresFields()){if(null===entity.edit){if(""===entity.name){var b=slug($("#entityName").val(),"_");$.each(dicionarios,function(c){c===b&&($("body").panel(themeNotify("Nome de Entidade j\xE1 existe","warning")),a=!1)}),a&&allowName(b)&&(entity.name=b,identifier[entity.name]=1,dicionarios[entity.name]={})}a&&(entity.edit=identifier[entity.name],identifier[entity.name]++)}a&&(saveAttrInputs(),resetAttr(),showEntity())}return a}function saveAttrInputs(){dicionarios[entity.name][entity.edit]=assignObject(defaults.default,defaults[getType()]),$.each($(".input"),function(){$(this).hasClass("hide")||saveAttrValue($(this))}),dicionarios[entity.name][entity.edit].allow.values=[],dicionarios[entity.name][entity.edit].allow.names=[],"source"===dicionarios[entity.name][entity.edit].format||"sources"===dicionarios[entity.name][entity.edit].format?checkSaveSource():checkSaveAllow()}function checkSaveSource(){$(".file-format").each(function(){$(this).prop("checked")&&$("."+$(this).attr("id")+"-format").each(function(){$(this).prop("checked")&&(dicionarios[entity.name][entity.edit].allow.values.push($(this).attr("id")),dicionarios[entity.name][entity.edit].allow.names.push($(this).attr("id")))})})}function checkSaveAllow(){""!==$("#spaceValueAllow").html()&&$.each($("#spaceValueAllow").find(".allow"),function(){saveAllowValue($(this))})}function saveAttrValue(a){var b=a.attr("id");"nome"===b&&(dicionarios[entity.name][entity.edit].column=slug(a.val(),"_")),-1<["default","size"].indexOf(b)&&!$("#"+b+"_custom").prop("checked")?dicionarios[entity.name][entity.edit][b]=!1:"form"===b?dicionarios[entity.name][entity.edit][b]=!!a.prop("checked")&&{}:!1!==dicionarios[entity.name][entity.edit].form&&-1<["class","style","coll","cols","colm","input"].indexOf(b)?dicionarios[entity.name][entity.edit].form[b]=a.val():"regex"===b?dicionarios[entity.name][entity.edit].allow[b]=a.val():dicionarios[entity.name][entity.edit][b]="checkbox"===a.attr("type")?a.prop("checked"):a.val()}function saveAllowValue(a){""!==a.find(".values").val()&&(dicionarios[entity.name][entity.edit].allow.values.push(a.find(".values").val()),dicionarios[entity.name][entity.edit].allow.names.push(a.find(".names").val()))}function applyAttr(a){"undefined"!=typeof a&&null!==a&&($.each(a,function(b,c){"object"==typeof c&&applyAttr(c),applyValueAttr(b,c)}),checkFieldsOpenOrClose())}function applyValueAttr(a,b){var c=$("#"+a);"values"===a||"names"===a?setAllow(a,b):"checkbox"===c.attr("type")&&(!1!==b&&!c.prop("checked")||!1===b&&c.prop("checked"))?c.trigger("click"):checkValuesEspAttr(a,b)}function checkValuesEspAttr(a,b){"default"===a||"size"===a?((!1!==b&&!$("#"+a+"_custom").prop("checked")||!1===b&&$("#"+a+"_custom").prop("checked"))&&$("#"+a+"_custom").trigger("click"),$("#"+a).val(!1===b?"":b)):"format"===a?setFormat(b):$("#"+a).val(b)}function setAllow(a,b){if("values"===a&&null!==entity.edit&&("source"===dicionarios[entity.name][entity.edit].format||"sources"===dicionarios[entity.name][entity.edit].format))$.each(b,function(d,f){$.each(data,function(h,j){-1<j.indexOf(f)&&!$("#"+h).prop("checked")&&($("#"+h).prop("checked",!0),$("#formato-"+h).removeClass("hide"))}),$("#"+f).prop("checked",!0)});else{var c=""===$("#spaceValueAllow").html();$.each(b,function(d,f){c&&copy("#tplValueAllow","#spaceValueAllow","","append");var h=c?$("#spaceValueAllow").find(".allow:last-child"):$("#spaceValueAllow").find(".allow:eq("+d+")");h.find("."+a).val(f)})}}function setFormat(a){$(".selectInput").css("color","#CCCCCC").val(""),getSelectInput(a).css("color","#333333").val(a),"source"===a||"sources"===a?($("#format-source").removeClass("hide"),$("#allowBtnAdd, #spaceValueAllow").addClass("hide")):($("#format-source").addClass("hide"),$("#allowBtnAdd, #spaceValueAllow").removeClass("hide"),-1<["extend","extend_mult","list","list_mult"].indexOf(a)?$("#relation_container").removeClass("hide"):$("#relation_container").addClass("hide")),$(".requireName, #nomeAttr").removeClass("hide"),$("#nome").focus()}function getSelectInput(a){return-1<["text","textarea","html","int","float","boolean","select","radio","checkbox","range","color","source","sources"].indexOf(a)?$("#funcaoPrimary"):-1<["extend","extend_mult","list","list_mult"].indexOf(a)?$("#funcaoRelation"):$("#funcaoIdentifier")}function checkRequiresFields(){var a=getType();return""!==a&&1<$("#nome").val().length&&"id"!==$("#nome").val()&&(0>["extend","extend_mult","list","list_mult"].indexOf(a)||null!==$("#relation").val())}function checkFieldsOpenOrClose(a){allowName(a)&&(checkRequiresFields()?$(".requireName").removeClass("hide"):$(".requireName").addClass("hide"))}function allowName(a){return!(0<["add","all","alter","analyze","and","as","asc","asensitive","before","between","bigint","binary","blob","both","by","call","cascade","case","change","char","character","check","collate","column","condition","connection","constraint","continue","convert","create","cross","current_date","current_time","current_timestamp","current_user","cursor","database","databases","day_hour","day_microsecond","day_minute","day_second","dec","decimal","declare","default","delayed","delete","desc","describe","deterministic","distinct","distinctrow","div","double","drop","dual","each","else","elseif","enclosed","escaped","exists","exit","explain","false","fetch","float","for","force","foreign","from","fulltext","goto","grant","group","having","high_priority","hour_microsecond","hour_minute","hour_second","if","ignore","in","index","infile","inner","inout","insensitive","insert","int","integer","interval","into","is","iterate","join","key","keys","kill","leading","leave","left","like","limit","lines","load","localtime","localtimestamp","lock","long","longblob","longtext","loop","low_priority","match","mediumblob","mediumint","mediumtext","middleint","minute_microsecond","minute_second","mod","modifies","natural","not","no_write_to_binlog","null","numeric","on","optimize","option","optionally","or","order","out","outer","outfile","precision","primary","procedure","purge","read","reads","real","references","regexp","rename","repeat","replace","require","restrict","return","revoke","right","rlike","schema","schemas","second_microsecond","select","sensitive","separator","set","show","smallint","soname","spatia","specific","sql","sqlexception","sqlstate","sqlwarning","sql_big_result","sql_calc_found_rows","sql_small_result","ssl","starting","straight_join","table","terminated","then","tinyblob","tinyint","tinytext","to","trailing","trigger","true","undo","union","unique","unlock","unsigned","update","usage","use","using","utc_date","utc_time","utc_timestamp","values","varbinary","varchar","varcharacter","varying","when","where","while","with","write","xor","year_month","zerofill"].indexOf(a))||($("body").panel(themeNotify("Este nome \xE9 reservado pelo sistema","error")),$(".requireName").addClass("hide"),!1)}function deleteAttr(a){delete dicionarios[entity.name][a],showEntity()}function removeEntity(a){confirm("Excluir esta entidade e todos os seus dados?")&&post("entity-form","delete/entity",{name:a},function(b){b&&($("body").panel(themeNotify("Entidade Exclu\xEDda","warning")),readDicionarios())})}$("input[type=range]").mousedown(function(){changeLeftRange($(this)),$(this).mousemove(function(){changeLeftRange($(this))})}).mouseup(function(){$(this).off("mousemove")}).change(function(){changeLeftRange($(this))}),$("#entityName").on("keyup change focus",function(){2<$(this).val().length?$("#requireNameEntity").removeClass("hide"):$("#requireNameEntity").addClass("hide")}),$("#relation").change(function(){checkFieldsOpenOrClose()}),$(".selectInput").change(function(){setFormat($(this).val()),applyAttr(assignObject(defaults.default,defaults[getType()])),checkFieldsOpenOrClose()}),$("#nome").on("keyup change",function(){checkFieldsOpenOrClose($(this).val())}),$("#default_custom").change(function(){$(this).is(":checked")?($("#default_container").removeClass("hide"),$("#default").focus(),$("#unique").is(":checked")&&$("#unique").trigger("click")):$("#default_container").addClass("hide")}),$("#size_custom").change(function(){$(this).is(":checked")?($("#size_container").removeClass("hide"),$("#size").focus()):$("#size_container").addClass("hide")}),$("#unique").change(function(){$(this).is(":checked")&&$("#default_custom").is(":checked")&&$("#default_custom").trigger("click")}),$("#form").change(function(){$(this).is(":checked")?$(".form_body").removeClass("hide"):$(".form_body").addClass("hide")}),$(".file-format").change(function(){$(this).is(":checked")?$("#formato-"+$(this).attr("id")).removeClass("hide"):$("#formato-"+$(this).attr("id")).addClass("hide")}).click(function(){var a=$(this);setTimeout(function(){a.prop("checked")&&!$("#all-"+a.attr("id")).prop("checked")&&$("#all-"+a.attr("id")).trigger("click")},50)}),$(".allformat").change(function(){$("."+$(this).attr("rel")+"-format").prop("checked",$(this).is(":checked"))}),$(".oneformat").change(function(){if(!$(this).is(":checked"))$("#all-"+$(this).attr("rel")).prop("checked",!1);else{var a=!0;$.each($("."+$(this).attr("rel")+"-format"),function(){a&&!$(this).is(":checked")&&(a=!1)}),$("#all-"+$(this).attr("rel")).prop("checked",a)}}),$("#colm").change(function(){var a=$("#coll"),b=$("#cols"),c=parseInt($(this).val());parseInt(a.val())>c&&(a.find("option").removeAttr("selected"),a.find("option[value="+$(this).val()+"]").attr("selected","selected")),parseInt(b.val())<c&&(b.find("option").removeAttr("selected"),b.find("option[value="+$(this).val()+"]").attr("selected","selected"))});function getDefaultsInfo(){var a=getType();return null===entity.edit?""===a?assignObject(defaults.default,{}):assignObject(defaults.default,defaults[getType()]):assignObject(defaults.default,dicionarios[entity.name][entity.edit])}function assignObject(a,b){var c="object"==typeof a?JSON.parse(JSON.stringify(a)):{};return $.each(b,function(d,f){c[d]="object"==typeof f?assignObject(c[d],f):f}),c}function getType(){var a="";return $(".selectInput").each(function(){null!==$(this).val()&&(a=$(this).val())}),a}