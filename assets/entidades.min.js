var entity={},dicionarios={},identifier={},defaults={},data={image:["png","jpg","jpeg","gif","bmp","tif","tiff","psd","svg"],video:["mp4","avi","mkv","mpeg","flv","wmv","mov","rmvb","vob","3gp","mpg"],audio:["mp3","aac","ogg","wma","mid","alac","flac","wav","pcm","aiff","ac3"],document:["txt","doc","docx","dot","dotx","dotm","ppt","pptx","pps","potm","potx","pdf","xls","xlsx","xltx","rtf"],compact:["rar","zip","tar","7z"],denveloper:["html","css","scss","js","tpl","json","xml","md","sql","dll"]};function readDefaults(){post("entity-form","load/defaults",function(e){defaults=e})}function readIdentifier(){post("entity-form","load/identifier",function(e){identifier=e})}function readDicionarios(){readIdentifier(),post("entity-form","load/dicionarios",function(e){dicionarios=e,$("#entity-space, #relation").html(""),$.each(dicionarios,function(e,t){copy("#tpl-entity","#entity-space",e,!0),$("#relation").append("<option value='"+e+"'>"+e+"</option>")})})}function entityReset(){entity={name:"",edit:null}}function entityEdit(e){void 0===e&&""!==entity.name||void 0!==e&&e!==entity.name?(saveEntity(!0),entityReset(),void 0!==e&&(entity.name=e),showEntity()):(showImport(),$("#entityName").focus())}function showEntity(){$("#entityName").val(entity.name).focus(),$("#entityAttr").html(""),$.each(dicionarios[entity.name],function(e,t){copy("#tpl-attrEntity","#entityAttr",[e,t.column],!0)}),showImport()}function showImport(){""===$("#entityAttr").html()?$("#importForm").removeClass("hide"):$("#importForm").addClass("hide")}function saveEntity(e){checkSaveAttr()&&entity.name.length>2&&void 0!==dicionarios[entity.name]&&!$.isEmptyObject(dicionarios[entity.name])&&post("entity-form","save/entity",{name:entity.name,dados:dicionarios[entity.name],id:identifier[entity.name]},function(t){t&&void 0===e&&($("body").panel(themeNotify("Salvo")),readDicionarios())})}function resetAttr(e){entity.edit=void 0!==e?e:null,$(".selectInput").css("color","#CCCCCC").val(""),$("#format-source").addClass("hide"),$("#allowBtnAdd, #spaceValueAllow").removeClass("hide"),$("#spaceValueAllow").html(""),$(".file-format").each(function(){$(this).prop("checked",!1),$("."+$(this).attr("id")+"-format").prop("checked",!1)}),null!==entity.edit?$(".selectInput, #relation").attr("disabled","disabled").addClass("disabled"):$(".selectInput, #relation").removeAttr("disabled").removeClass("disabled"),applyAttr(getDefaultsInfo())}function editAttr(e){e!==entity.edit&&checkSaveAttr()&&resetAttr(e)}function checkSaveAttr(){var e=!0;if(checkRequiresFields()){if(null===entity.edit){if(""===entity.name){var t=slug($("#entityName").val(),"_");$.each(dicionarios,function(i,n){i===t&&($("body").panel(themeNotify("Nome de Entidade já existe","warning")),e=!1)}),e&&allowName(t)&&(entity.name=t,identifier[entity.name]=1,dicionarios[entity.name]={})}e&&(entity.edit=identifier[entity.name],identifier[entity.name]++)}e&&(saveAttrInputs(),resetAttr(),showEntity())}return e}function saveAttrInputs(){dicionarios[entity.name][entity.edit]=assignObject(defaults.default,defaults[getType()]),$.each($(".input"),function(){$(this).hasClass("hide")||saveAttrValue($(this))}),dicionarios[entity.name][entity.edit].allow.values=[],dicionarios[entity.name][entity.edit].allow.names=[],"source"===dicionarios[entity.name][entity.edit].format||"sources"===dicionarios[entity.name][entity.edit].format?checkSaveSource():checkSaveAllow()}function checkSaveSource(){$(".file-format").each(function(){$(this).prop("checked")&&$("."+$(this).attr("id")+"-format").each(function(){$(this).prop("checked")&&(dicionarios[entity.name][entity.edit].allow.values.push($(this).attr("id")),dicionarios[entity.name][entity.edit].allow.names.push($(this).attr("id")))})})}function checkSaveAllow(){""!==$("#spaceValueAllow").html()&&$.each($("#spaceValueAllow").find(".allow"),function(){saveAllowValue($(this))})}function saveAttrValue(e){var t=e.attr("id");"nome"===t&&(dicionarios[entity.name][entity.edit].column=slug(e.val(),"_")),["default","size"].indexOf(t)>-1&&!$("#"+t+"_custom").prop("checked")?dicionarios[entity.name][entity.edit][t]=!1:"form"===t?dicionarios[entity.name][entity.edit][t]=!!e.prop("checked")&&{}:!1!==dicionarios[entity.name][entity.edit].form&&["class","style","coll","cols","colm","input"].indexOf(t)>-1?dicionarios[entity.name][entity.edit].form[t]=e.val():"regex"===t?dicionarios[entity.name][entity.edit].allow[t]=e.val():dicionarios[entity.name][entity.edit][t]="checkbox"===e.attr("type")?e.prop("checked"):e.val()}function saveAllowValue(e){""!==e.find(".values").val()&&(dicionarios[entity.name][entity.edit].allow.values.push(e.find(".values").val()),dicionarios[entity.name][entity.edit].allow.names.push(e.find(".names").val()))}function applyAttr(e){void 0!==e&&null!==e&&($.each(e,function(e,t){"object"==typeof t&&applyAttr(t),applyValueAttr(e,t)}),checkFieldsOpenOrClose())}function applyValueAttr(e,t){var i=$("#"+e);"values"===e||"names"===e?setAllow(e,t):"checkbox"===i.attr("type")&&(!1!==t&&!i.prop("checked")||!1===t&&i.prop("checked"))?i.trigger("click"):checkValuesEspAttr(e,t)}function checkValuesEspAttr(e,t){"default"===e||"size"===e?((!1!==t&&!$("#"+e+"_custom").prop("checked")||!1===t&&$("#"+e+"_custom").prop("checked"))&&$("#"+e+"_custom").trigger("click"),$("#"+e).val(!1!==t?t:"")):"format"===e?setFormat(t):$("#"+e).val(t)}function setAllow(e,t){if("values"!==e||null===entity.edit||"source"!==dicionarios[entity.name][entity.edit].format&&"sources"!==dicionarios[entity.name][entity.edit].format){var i=""===$("#spaceValueAllow").html();$.each(t,function(t,n){i&&copy("#tplValueAllow","#spaceValueAllow","","append"),(i?$("#spaceValueAllow").find(".allow:last-child"):$("#spaceValueAllow").find(".allow:eq("+t+")")).find("."+e).val(n)})}else $.each(t,function(e,t){$.each(data,function(e,i){i.indexOf(t)>-1&&!$("#"+e).prop("checked")&&($("#"+e).prop("checked",!0),$("#formato-"+e).removeClass("hide"))}),$("#"+t).prop("checked",!0)})}function setFormat(e){$(".selectInput").css("color","#CCCCCC").val(""),getSelectInput(e).css("color","#333333").val(e),"source"===e||"sources"===e?($("#format-source").removeClass("hide"),$("#allowBtnAdd, #spaceValueAllow").addClass("hide")):($("#format-source").addClass("hide"),$("#allowBtnAdd, #spaceValueAllow").removeClass("hide"),["extend","extend_mult","list","list_mult"].indexOf(e)>-1?$("#relation_container").removeClass("hide"):$("#relation_container").addClass("hide")),$(".requireName, #nomeAttr").removeClass("hide"),$("#nome").focus()}function getSelectInput(e){return["text","textarea","html","int","float","boolean","select","radio","checkbox","range","color","source","sources"].indexOf(e)>-1?$("#funcaoPrimary"):["extend","extend_mult","list","list_mult"].indexOf(e)>-1?$("#funcaoRelation"):$("#funcaoIdentifier")}function checkRequiresFields(){var e=getType();return""!==e&&$("#nome").val().length>1&&"id"!==$("#nome").val()&&(["extend","extend_mult","list","list_mult"].indexOf(e)<0||null!==$("#relation").val())}function checkFieldsOpenOrClose(e){allowName(e)&&(checkRequiresFields()?$(".requireName").removeClass("hide"):$(".requireName").addClass("hide"))}function allowName(e){return!(["add","all","alter","analyze","and","as","asc","asensitive","before","between","bigint","binary","blob","both","by","call","cascade","case","change","char","character","check","collate","column","condition","connection","constraint","continue","convert","create","cross","current_date","current_time","current_timestamp","current_user","cursor","database","databases","day_hour","day_microsecond","day_minute","day_second","dec","decimal","declare","default","delayed","delete","desc","describe","deterministic","distinct","distinctrow","div","double","drop","dual","each","else","elseif","enclosed","escaped","exists","exit","explain","false","fetch","float","for","force","foreign","from","fulltext","goto","grant","group","having","high_priority","hour_microsecond","hour_minute","hour_second","if","ignore","in","index","infile","inner","inout","insensitive","insert","int","integer","interval","into","is","iterate","join","key","keys","kill","leading","leave","left","like","limit","lines","load","localtime","localtimestamp","lock","long","longblob","longtext","loop","low_priority","match","mediumblob","mediumint","mediumtext","middleint","minute_microsecond","minute_second","mod","modifies","natural","not","no_write_to_binlog","null","numeric","on","optimize","option","optionally","or","order","out","outer","outfile","precision","primary","procedure","purge","read","reads","real","references","regexp","rename","repeat","replace","require","restrict","return","revoke","right","rlike","schema","schemas","second_microsecond","select","sensitive","separator","set","show","smallint","soname","spatia","specific","sql","sqlexception","sqlstate","sqlwarning","sql_big_result","sql_calc_found_rows","sql_small_result","ssl","starting","straight_join","table","terminated","then","tinyblob","tinyint","tinytext","to","trailing","trigger","true","undo","union","unique","unlock","unsigned","update","usage","use","using","utc_date","utc_time","utc_timestamp","values","varbinary","varchar","varcharacter","varying","when","where","while","with","write","xor","year_month","zerofill"].indexOf(e)>0)||($("body").panel(themeNotify("Este nome é reservado pelo sistema","error")),$(".requireName").addClass("hide"),!1)}function deleteAttr(e){delete dicionarios[entity.name][e],showEntity()}function removeEntity(e){confirm("Excluir esta entidade e todos os seus dados?")&&post("entity-form","delete/entity",{name:e},function(e){e&&($("body").panel(themeNotify("Entidade Excluída","warning")),readDicionarios())})}function sendImport(){if(""!==$("#import").val()){var e=new FormData;e.append("file",$("#import").prop("files")[0]),$.ajax({url:HOME+"entidadesImport",dataType:"text",cache:!1,contentType:!1,processData:!1,data:e,type:"post",success:function(e){e?("existe"===e?toast("Entidade já Existe","warning",2500):(toast("Rejeitado! Chave Estrangeira Ausente","warning",4e3),post("entity-form","delete/import",{entity:$("#import").val()},function(e){})),$("#import").val("")):location.reload()}})}}function getDefaultsInfo(){var e=getType();return null!==entity.edit?assignObject(defaults.default,dicionarios[entity.name][entity.edit]):assignObject(defaults.default,""!==e?defaults[getType()]:{})}function assignObject(e,t){var i="object"==typeof e?JSON.parse(JSON.stringify(e)):{};return $.each(t,function(e,t){i[e]="object"==typeof t?assignObject(i[e],t):t}),i}function getType(){var e="";return $(".selectInput").each(function(){null!==$(this).val()&&(e=$(this).val())}),e}readDefaults(),readDicionarios(),entityReset(),$("input[type=range]").mousedown(function(){changeLeftRange($(this)),$(this).mousemove(function(){changeLeftRange($(this))})}).mouseup(function(){$(this).off("mousemove")}).change(function(){changeLeftRange($(this))}),$("#entityName").on("keyup change focus",function(){$(this).val().length>2?$("#requireNameEntity").removeClass("hide"):$("#requireNameEntity").addClass("hide")}),$("#relation").change(function(){checkFieldsOpenOrClose()}),$(".selectInput").change(function(){setFormat($(this).val()),applyAttr(assignObject(defaults.default,defaults[getType()])),checkFieldsOpenOrClose()}),$("#nome").on("keyup change",function(){checkFieldsOpenOrClose($(this).val())}),$("#default_custom").change(function(){$(this).is(":checked")?($("#default_container").removeClass("hide"),$("#default").focus(),$("#unique").is(":checked")&&$("#unique").trigger("click")):$("#default_container").addClass("hide")}),$("#size_custom").change(function(){$(this).is(":checked")?($("#size_container").removeClass("hide"),$("#size").focus()):$("#size_container").addClass("hide")}),$("#unique").change(function(){$(this).is(":checked")&&$("#default_custom").is(":checked")&&$("#default_custom").trigger("click")}),$("#form").change(function(){$(this).is(":checked")?$(".form_body").removeClass("hide"):$(".form_body").addClass("hide")}),$(".file-format").change(function(){$(this).is(":checked")?$("#formato-"+$(this).attr("id")).removeClass("hide"):$("#formato-"+$(this).attr("id")).addClass("hide")}).click(function(){var e=$(this);setTimeout(function(){e.prop("checked")&&!$("#all-"+e.attr("id")).prop("checked")&&$("#all-"+e.attr("id")).trigger("click")},50)}),$(".allformat").change(function(){$("."+$(this).attr("rel")+"-format").prop("checked",$(this).is(":checked"))}),$(".oneformat").change(function(){if($(this).is(":checked")){var e=!0;$.each($("."+$(this).attr("rel")+"-format"),function(){e&&!$(this).is(":checked")&&(e=!1)}),$("#all-"+$(this).attr("rel")).prop("checked",e)}else $("#all-"+$(this).attr("rel")).prop("checked",!1)}),$("#colm").change(function(){var e=$("#coll"),t=$("#cols"),i=parseInt($(this).val());parseInt(e.val())>i&&(e.find("option").removeAttr("selected"),e.find("option[value="+$(this).val()+"]").attr("selected","selected")),parseInt(t.val())<i&&(t.find("option").removeAttr("selected"),t.find("option[value="+$(this).val()+"]").attr("selected","selected"))});